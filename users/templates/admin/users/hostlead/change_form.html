{% extends "admin/change_form.html" %}
{% load i18n %}

{% block after_related_objects %}
{{ block.super }}

<div class="module" id="whatsapp">
  <h2>{% trans "Host Lead WhatsApp Message" %}</h2>
  <p class="help">
    {% trans "Choose a recommended message to populate the body. Template slot #1 auto-fills with the host's first name; you control template slot #2 below." %}
  </p>

  {{ whatsapp_form.template_id }}

  {% if whatsapp_recommendations %}
    <div class="whatsapp-recommendations" data-whatsapp-recommendations>
      <p class="help">{% trans "Recommended messages (most-used first):" %}</p>
      <div class="whatsapp-recommendations__grid">
        {% for item in whatsapp_recommendations %}
          <button type="button"
                  class="whatsapp-recommendations__item"
                  data-template-id="{{ item.id }}"
                  data-message="{{ item.message|escapejs }}">
            <span class="whatsapp-recommendations__title">{{ item.name }}</span>
            <span class="whatsapp-recommendations__usage">
              {{ item.usage_count }} {% trans "sent" %}
            </span>
            <span class="whatsapp-recommendations__body">{{ item.message }}</span>
          </button>
        {% endfor %}
      </div>
    </div>
  {% else %}
    <p class="help">
      {% trans "No recommendations yet. Add predefined messages under Host Lead WhatsApp Templates." %}
    </p>
  {% endif %}

  <div class="form-row">
    <label for="id_whatsapp_message">{% trans "Message body (template slot #2)" %}</label>
    {{ whatsapp_form.whatsapp_message }}
    {% if whatsapp_form.whatsapp_message.errors %}
      <div class="errors">{{ whatsapp_form.whatsapp_message.errors }}</div>
    {% endif %}
  </div>

  <div class="form-row whatsapp-preview">
    <label>{% trans "Final WhatsApp preview" %}</label>
    <pre id="whatsapp-template-preview" class="whatsapp-preview__body"></pre>
  </div>

  <div class="submit-row">
    <button type="submit" name="_send_whatsapp" value="1" class="button default">
      {% trans "Send WhatsApp Message" %}
    </button>
  </div>
</div>
{% endblock %}

{% block extrahead %}
{{ block.super }}
<script>
(function() {
  function getMessageField() {
    return document.querySelector('#id_whatsapp_message, textarea[name="whatsapp_message"]');
  }

  function getFirstName() {
    const field = document.querySelector('#id_first_name, input[name="first_name"]');
    return field && field.value.trim() ? field.value.trim() : '{{1}}';
  }

  function renderPreview() {
    const preview = document.getElementById('whatsapp-template-preview');
    const msgField = getMessageField();
    if (!preview || !msgField) return;

    const slot2 = msgField.value.trim() || '{{2}}';
    const lines = [
      `Hi ${getFirstName()}! ðŸ‘‹ Iâ€™m Senan, Host Manager at Loopinx Circle.`,
      '',
      "Hereâ€™s a quick message regarding your Host journey:",
      slot2,
      '',
      "Weâ€™ll stay in touch as things progress!",
      "â€” Senan\nHost Manager"
    ];
    preview.textContent = lines.join('\n');
  }

  function applyRecommendation(button) {
    const message = button.dataset.message || '';
    const msgField = getMessageField();
    if (!msgField) {
      console.warn('[WhatsApp Admin] message field not found.');
      return;
    }
    msgField.value = message;
    msgField.dispatchEvent(new Event('input', { bubbles: true }));

    document.querySelectorAll('.whatsapp-recommendations__item.is-selected')
      .forEach(b => b.classList.remove('is-selected'));
    button.classList.add('is-selected');

    const hiddenTemplateField = document.querySelector('#id_template_id, input[name=\"template_id\"]');
    if (hiddenTemplateField) {
      hiddenTemplateField.value = button.dataset.templateId || '';
    }

    renderPreview();
  }

  function bindRecommendations() {
    const msgField = getMessageField();
    if (msgField) {
      msgField.removeEventListener('input', renderPreview);
      msgField.addEventListener('input', renderPreview);
    }

    document.querySelectorAll('.whatsapp-recommendations__item').forEach(btn => {
      btn.removeEventListener('click', btn.__whatsappClickHandler || (() => {}));
      btn.__whatsappClickHandler = e => {
        e.preventDefault();
        applyRecommendation(btn);
      };
      btn.addEventListener('click', btn.__whatsappClickHandler);
    });

    renderPreview();
  }

  function init() {
    bindRecommendations();
    renderPreview();

    const container = document.querySelector('[data-whatsapp-recommendations]');
    if (container) {
      new MutationObserver(bindRecommendations).observe(container, { childList: true, subtree: true });
    }
  }

  window.addEventListener('load', init);
})();
</script>

<style>
  .whatsapp-recommendations__grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap: 12px;
    margin-bottom: 12px;
  }

  .whatsapp-recommendations__item {
    border: 1px solid #d0d0d0;
    border-radius: 6px;
    padding: 12px;
    text-align: left;
    background: #f9f9f9;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    gap: 4px;
    transition: all 0.2s ease;
  }

  .whatsapp-recommendations__item:hover {
    border-color: #3c91ff;
    box-shadow: 0 2px 6px rgba(60,145,255,0.2);
    background: #fff;
  }

  .whatsapp-recommendations__item.is-selected {
    border-color: #0d6efd;
    box-shadow: 0 0 0 2px rgba(13,110,253,0.2);
    background: #eef5ff;
  }

  .whatsapp-recommendations__title {
    font-weight: 600;
    color: #1b1b1b;
  }

  .whatsapp-recommendations__usage {
    font-size: 12px;
    color: #6c757d;
    text-transform: uppercase;
  }

  .whatsapp-recommendations__body {
    font-size: 13px;
    color: #333;
    line-height: 1.4;
  }

  .whatsapp-preview__body {
    background: #0f172a;
    color: #e2e8f0;
    border-radius: 8px;
    padding: 12px;
    white-space: pre-wrap;
    font-family: monospace;
    line-height: 1.6;
    box-shadow: inset 0 0 0 1px rgba(15,23,42,0.4);
    margin-top: 8px;
  }
</style>
{% endblock %}
