{% extends "admin/base_site.html" %}
{% load i18n admin_urls static admin_modify humanize %}

{% block title %}Preview Campaign Audience | {{ site_title|default:_('Django site admin') }}{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
<a href="{% url 'admin:index' %}">{% trans 'Home' %}</a>
&rsaquo; <a href="{% url 'admin:app_list' app_label=opts.app_label %}">{{ opts.app_config.verbose_name }}</a>
&rsaquo; <a href="{% url 'admin:notifications_campaign_changelist' %}">Campaigns</a>
&rsaquo; <a href="{% url 'admin:notifications_campaign_change' campaign.pk %}">{{ campaign.name }}</a>
&rsaquo; Preview Audience
</div>
{% endblock %}

{% block content %}
<h1>Preview Campaign Audience</h1>

<div style="background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin: 20px 0;">
    <h2 style="margin-top: 0;">{{ campaign.name }}</h2>
    
    {% if preview_result %}
    <div style="background: #e3f2fd; border-left: 4px solid #2196f3; padding: 15px; margin: 20px 0; border-radius: 4px;">
        <h3 style="margin-top: 0; color: #1976d2;">Preview Results</h3>
        <div style="font-size: 24px; font-weight: bold; color: #1976d2; margin: 10px 0;">
            {{ preview_result.count|floatformat:0|intcomma }} users
        </div>
        <p style="color: #555; margin: 10px 0 0 0;">
            {{ preview_result.human_readable }}
        </p>
        {% if preview_result.has_more %}
        <p style="color: #f44336; margin: 10px 0 0 0; font-size: 13px;">
            ⚠️ Showing first 100 users. Total matches: {{ preview_result.count|floatformat:0|intcomma }}
        </p>
        {% endif %}
    </div>
    
    <div style="background: #f5f5f5; padding: 15px; border-radius: 4px; margin: 20px 0;">
        <h4 style="margin-top: 0;">Sample User IDs (first {{ preview_result.sample_user_ids|length }})</h4>
        <div style="font-family: monospace; font-size: 12px; color: #666; max-height: 200px; overflow-y: auto;">
            {% for user_id in preview_result.sample_user_ids %}
            <div style="padding: 4px 0;">{{ user_id }}</div>
            {% endfor %}
        </div>
    </div>
    {% else %}
    <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin: 20px 0; border-radius: 4px;">
        <p style="margin: 0; color: #856404;">No preview available. Please check audience rules.</p>
    </div>
    {% endif %}
</div>

<div style="background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin: 20px 0;">
    <h3 style="margin-top: 0;">Audience Rules</h3>
    <pre style="background: #f5f5f5; padding: 15px; border-radius: 4px; overflow-x: auto; font-size: 13px;">{{ campaign.audience_rules|pprint }}</pre>
</div>

<div style="margin: 20px 0;">
    <form method="post" style="display: inline;">
        {% csrf_token %}
        <button type="submit" style="background: #2196f3; color: white; padding: 12px 24px; border: none; border-radius: 4px; font-size: 14px; font-weight: bold; cursor: pointer; margin-right: 10px;">
            Update Preview
        </button>
    </form>
    <a href="{% url 'admin:notifications_campaign_change' campaign.pk %}" style="background: #6c757d; color: white; padding: 12px 24px; border: none; border-radius: 4px; font-size: 14px; font-weight: bold; text-decoration: none; display: inline-block;">
        Back to Campaign
    </a>
    {% if preview_result and preview_result.count > 0 %}
    <a href="{% url 'admin:notifications_campaign_execute' campaign.pk %}" style="background: #4caf50; color: white; padding: 12px 24px; border: none; border-radius: 4px; font-size: 14px; font-weight: bold; text-decoration: none; display: inline-block; margin-left: 10px;">
        Proceed to Send
    </a>
    {% endif %}
</div>

{% endblock %}